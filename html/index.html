<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Examination Flow Client Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        #status { font-weight: bold; }
        .output { margin-top: 15px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; height: 300px; overflow-y: scroll; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px dotted #eee; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<div class="container">
    <h1>üë®‚Äç‚öïÔ∏è Examination Flow Client Test</h1>

    <p>Tr·∫°ng th√°i k·∫øt n·ªëi: <span id="status">ƒêang ng·∫Øt k·∫øt n·ªëi...</span></p>
    <hr>
    
    <h2>1. H√†nh ƒë·ªông</h2>
    <label for="doctor-token">JWT Token:</label>
    <input type="text" id="doctor-token" size="60" value="BS001" placeholder="Nh·∫≠p JWT Token h·ª£p l·ªá">
    
    <label for="department-id">Dept ID:</label>
    <input type="text" id="department-id" size="10" value="2650337d-8252-4034-a530-1a716e619aee" placeholder="V√≠ d·ª•: ULTRASOUND">
    <br><br>
    
    <button onclick="attemptConnect()">K·∫øt n·ªëi WebSocket</button>
    <button onclick="takeNextPatient()" id="take-next-btn" disabled>L·∫•y Phi·∫øu Kh√°m Ti·∫øp Theo</button>
    <button onclick="requestInitialQueueState(currentDepartmentId)" id="take-queue-size-btn" disabled>L·∫•y queue size</button>
    
    <hr>
    
    <h2>2. Th√¥ng tin Nh·∫≠n ƒë∆∞·ª£c</h2>
    <p>Queue Size (ULTRASOUND): <span id="queue-size" style="font-size: 1.2em; color: blue;">N/A</span></p>
    
    <h3>Chi ti·∫øt Phi·∫øu Kh√°m C√° nh√¢n:</h3>
    <div id="item-details" class="output" style="height: 100px;">Ch∆∞a nh·∫≠n ƒë∆∞·ª£c chi ti·∫øt phi·∫øu kh√°m...</div>
    
    <h3>Log Giao ti·∫øp:</h3>
    <div id="log-output" class="output"></div>
</div>

<script>
    // --- C·∫•u h√¨nh Server ---
    const SERVER_URL = 'http://localhost:9093'; 
    const HANDSHAKE_ENDPOINT = '/ws/exam-workflow'; 
    const COMMAND_TAKE_ITEM = '/app/exam-workflow/queue/take-next';
    const SUBSCRIBE_QUEUE_LIST = '/topic/exam-workflow/queue/'; 
    const SUBSCRIBE_ITEM_DETAILS = '/user/queue/exam-workflow/item/details'; 
    const SUBSCRIBE_QUEUE_SIZE_REPLY = '/user/queue/query-size-reply';
    const SUBSCRIBE_ERROR_CHANNEL = '/user/queue/errors';
    const COMMAND_QUERY_QUEUE_SIZE = '/app/exam-workflow/query/queue-size';

    let stompClient = null;
    let currentDepartmentId = null; 

    // H√†m ghi log ra giao di·ªán
    function logMessage(message, type = 'info') {
        const log = document.getElementById('log-output');
        const now = new Date().toLocaleTimeString();
        log.innerHTML = `<div class="log-entry" style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'black'};">
            [${now}] [${type.toUpperCase()}] ${message}
        </div>` + log.innerHTML;
    }

    // --- H√†m K·∫øt n·ªëi ---
    function attemptConnect() {
        const token = document.getElementById('doctor-token').value;
        const departmentId = document.getElementById('department-id').value;
        
        if (!token || !departmentId) {
            logMessage("Vui l√≤ng nh·∫≠p Token v√† Dept ID.", 'error');
            return;
        }

        currentDepartmentId = departmentId;
        logMessage(`ƒêang c·ªë k·∫øt n·ªëi t·ªõi: ${SERVER_URL + HANDSHAKE_ENDPOINT}`, 'info');

        const socket = new SockJS(SERVER_URL + HANDSHAKE_ENDPOINT);
        stompClient = Stomp.over(socket);

        // Thi·∫øt l·∫≠p Header STOMP CONNECT (Truy·ªÅn JWT)
        const headers = {
            'Authorization': 'Bearer ' + token, 
        };
        
        stompClient.connect(headers, 
            (frame) => {
                document.getElementById('status').textContent = 'ƒê√É K·∫æT N·ªêI (Principal: ' + frame.headers.user + ')';
                document.getElementById('status').style.color = 'green';
                document.getElementById('take-next-btn').disabled = false;
                document.getElementById('take-queue-size-btn').disabled = false;
                logMessage('K·∫øt n·ªëi th√†nh c√¥ng. B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω k√™nh.', 'success');
                subscribeToChannels(currentDepartmentId);
            }, 
            (error) => {
                document.getElementById('status').textContent = 'L·ªñI K·∫æT N·ªêI: ' + (error.message || error);
                document.getElementById('status').style.color = 'red';
                document.getElementById('take-next-btn').disabled = true;
                document.getElementById('take-queue-size-btn').disabled = true;
                logMessage('L·ªói k·∫øt n·ªëi WebSocket: ' + error, 'error');
                console.error(error);
            }
        );
    }

    // --- H√†m Subscription ---
    function subscribeToChannels(departmentId) {
        // 1. Subscribe k√™nh chung c·ªßa ph√≤ng ban
        const queueListDestination = SUBSCRIBE_QUEUE_LIST + departmentId + '/list';
        stompClient.subscribe(queueListDestination, (message) => {
            const payload = JSON.parse(message.body);
            logMessage(`[PUB/SUB] C·∫≠p nh·∫≠t Queue (${departmentId}): Size = ${payload}`, 'info');
            document.getElementById('queue-size').textContent = payload; // Nh·∫≠n size l√† Integer
        });

        // 2. Subscribe k√™nh c√° nh√¢n
        stompClient.subscribe(SUBSCRIBE_ITEM_DETAILS, (message) => {
            const details = JSON.parse(message.body);
            logMessage(`[PRIVATE] Nh·∫≠n Chi ti·∫øt Phi·∫øu kh√°m cho ID: ${details.queueItemId}`, 'success');
            document.getElementById('item-details').textContent = JSON.stringify(details, null, 2);
        },{id: 'item-details-sub'});

        // 3. Subscribe K√™nh Nh·∫≠n Ph·∫£n h·ªìi Query K√≠ch th∆∞·ªõc H√†ng ƒë·ª£i
        stompClient.subscribe(SUBSCRIBE_QUEUE_SIZE_REPLY, (message) => {
            const currentSize = JSON.parse(message.body);
            logMessage(`[REPLY] Nh·∫≠n k√≠ch th∆∞·ªõc h√†ng ƒë·ª£i ban ƒë·∫ßu: ${currentSize}`, 'success');
            document.getElementById('queue-size').textContent = currentSize;
        },{id: 'queue-size-reply-sub'});

        // 4. B·ªî SUNG: Subscribe k√™nh nh·∫≠n l·ªói
        stompClient.subscribe(SUBSCRIBE_ERROR_CHANNEL, (message) => {
            let errorText = message.body;
            try {
                // Th·ª≠ ph√¢n t√≠ch JSON (Spring th∆∞·ªùng g·ª≠i l·ªói d∆∞·ªõi d·∫°ng JSON)
                const errorObj = JSON.parse(message.body);
                errorText = errorObj.message || errorObj.error || JSON.stringify(errorObj);
            } catch (e) {
                // N·∫øu kh√¥ng ph·∫£i JSON, d√πng body th√¥
                errorText = message.body;
            }
            logMessage(`[ERROR] L·ªói t·ª´ Server: ${errorText}`, 'error');
            
            // X√≥a chi ti·∫øt phi·∫øu kh√°m n·∫øu l·ªói li√™n quan ƒë·∫øn vi·ªác l·∫•y phi·∫øu
            document.getElementById('item-details').textContent = "Kh√¥ng th·ªÉ l·∫•y phi·∫øu: " + errorText;
            document.getElementById('take-next-btn').disabled = false; // B·∫≠t l·∫°i n√∫t
        }, {id: 'error-sub'}); // ƒê·∫∑t ID cho Subscription

        // Sau khi SUBSCRIBE xong, g·ª≠i y√™u c·∫ßu l·∫•y tr·∫°ng th√°i ban ƒë·∫ßu
        requestInitialQueueState(departmentId);
    }

    function requestInitialQueueState(queueId) {
        if (!stompClient || !stompClient.connected) {
            logMessage("L·ªói: K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng ƒë·ªÉ g·ª≠i Query.", 'error');
            return;
        }

        // G·ª≠i t√™n ph√≤ng ban l√†m payload (v√≠ d·ª•: "ULTRASOUND")
        stompClient.send(COMMAND_QUERY_QUEUE_SIZE, {}, JSON.stringify(queueId));
        logMessage(`[SEND] G·ª≠i y√™u c·∫ßu l·∫•y Queue Size hi·ªán t·∫°i cho ph√≤ng: ${queueId}`, 'info');
    }

    // --- H√†m G·ª≠i Command ---
    function takeNextPatient() {
        if (!stompClient || !stompClient.connected) {
            logMessage("K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng. Vui l√≤ng k·∫øt n·ªëi tr∆∞·ªõc.", 'error');
            return;
        }

        const payload = {
            queueId: currentDepartmentId
            // C√°c tr∆∞·ªùng kh√°c n·∫øu c·∫ßn (v√≠ d·ª•: deviceId, kioskId)
        };

        stompClient.send(COMMAND_TAKE_ITEM, {}, JSON.stringify(payload));
        logMessage(`[SEND] G·ª≠i l·ªánh l·∫•y phi·∫øu cho ph√≤ng: ${currentDepartmentId}`, 'info');
    }
    
    // ƒê·∫£m b·∫£o n√∫t "L·∫•y phi·∫øu" s·∫µn s√†ng
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('take-next-btn').disabled = true;
    });

</script>

</body>
</html>
