<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Examination Flow Client Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        #status { font-weight: bold; }
        .output { margin-top: 15px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; height: 300px; overflow-y: scroll; word-wrap: break-word; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px dotted #eee; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .exam-form, .payment-form { display: none; padding: 15px; border: 2px solid #ddd; border-radius: 5px; margin-top: 10px; }
        .exam-form { border-color: #4CAF50; background-color: #f1f8f4; }
        .payment-form { border-color: #2196F3; background-color: #e3f2fd; }
        .form-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<div class="container">
    <h1>üë®‚Äç‚öïÔ∏è Examination Flow Client Test</h1>

    <p>Tr·∫°ng th√°i k·∫øt n·ªëi: <span id="status">ƒêang ng·∫Øt k·∫øt n·ªëi...</span></p>
    <hr>
    
    <h2>1. H√†nh ƒë·ªông</h2>
    <label for="doctor-token">Staff ID (for testing):</label>
    <input type="text" id="doctor-token" size="60" value="" placeholder="Nh·∫≠p Staff ID ƒë·ªÉ test">
    <br><br>
    <label for="department-id">Dept ID:</label>
    <input type="text" id="department-id" size="60" value="" placeholder="queue id">
    <br><br>
    
    <button onclick="attemptConnect()">K·∫øt n·ªëi WebSocket</button>
    <button onclick="takeNextPatient()" id="take-next-btn" disabled>L·∫•y Phi·∫øu Kh√°m Ti·∫øp Theo</button>
    <button onclick="requestInitialQueueState(currentDepartmentId)" id="take-queue-size-btn" disabled>L·∫•y queue size</button>
    <button onclick="getInProgressPatient()" id="get-in-progress-btn" disabled>L·∫•y Phi·∫øu ƒêang X·ª≠ L√Ω</button>
    
    <hr>

<hr>
<h2>2. Th√¥ng tin Nh·∫≠n ƒë∆∞·ª£c</h2>
<p>Queue Size: <span id="queue-size" style="color: blue; font-weight: bold">N/A</span></p>


<h3>Chi ti·∫øt Phi·∫øu Kh√°m C·∫ßn X·ª≠ l√Ω</h3>
<div id="item-details" class="output">Ch∆∞a c√≥ d·ªØ li·ªáu...</div>


<div class="block">
<p class="detail-line"><strong>Tr·∫°ng th√°i:</strong> <span id="patient-status">N/A</span></p>
<p class="detail-line"><strong>B·ªánh nh√¢n:</strong> <span id="patient-name">N/A</span> (<span id="patient-id">N/A</span>)</p>
<p class="detail-line"><strong>D·ªãch v·ª•:</strong> <span id="service-name">N/A</span> (<span id="service-id-view">N/A</span>)</p>
<p class="detail-line"><strong>Queue Item ID:</strong> <span id="queueItemIdView">N/A</span></p>
<p class="detail-line"><strong>Exam ID:</strong> <span id="examIdView">N/A</span></p>
<p class="detail-line"><strong>Type:</strong> <span id="queueItemType">N/A</span></p>
</div>


<h3>Log</h3>
<div id="log-output" class="output"></div>
<hr>


<h2>3. Ho√†n th√†nh Phi·∫øu</h2>

<!-- Form for EXAM_SERVICE -->
<div id="exam-form" class="exam-form">
    <div class="form-title">üìã Ho√†n Th√†nh Kh√°m B·ªánh</div>
    <label>Queue Item ID:</label>
    <input id="queueItemIdInput" size="40" disabled>
    <br><label>Exam ID:</label>
    <input id="examIdInput" size="40" disabled>
    <br><label>Service ID:</label>
    <input id="serviceIdInput" size="40" disabled>
    <br><br>
    <label>Exam Data (JSON):</label>
    <textarea id="examData" rows="4" cols="60">{"description": "Thai ph√°t tri·ªÉn b√¨nh th∆∞·ªùng, kh√¥ng ph√°t hi·ªán b·∫•t th∆∞·ªùng.", "image1": "https://s3.amazonaws.com/clinic/uploads/ultra_001.png", "doctorNote": "Ti·∫øp t·ª•c theo d√µi ƒë·ªãnh k·ª≥, s·ª©c kh·ªèe ·ªïn ƒë·ªãnh."}</textarea>
    <br><br>
    <button onclick="completeExam()">Ho√†n Th√†nh Kh√°m</button>
</div>

<!-- Form for RECEPTION_PAYMENT -->
<div id="payment-form" class="payment-form">
    <div class="form-title">üí≥ T·∫°o Giao D·ªãch Thanh To√°n</div>
    <label>Invoice ID:</label>
    <input id="invoiceIdInput" size="40" disabled>
    <br><label>Payment Method:</label>
    <input id="paymentMethodInput" size="40" value="VNPAY">
    <br><br>
    <button onclick="createPaymentTransaction()">T·∫°o Giao D·ªãch</button>
</div>

<script>
    // --- C·∫•u h√¨nh Server ---
    const SERVER_URL = 'http://localhost:9093'; 
    const HANDSHAKE_ENDPOINT = '/ws/exam-workflow'; 
    const EXAMINATION_SERVICE_URL = 'http://localhost:9094';
    const PAYMENT_SERVICE_URL = 'http://localhost:9098';
    
    // C√°c k√™nh giao ti·∫øp STOMP n·ªôi b·ªô ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh
    const COMMAND_TAKE_ITEM = '/app/exam-workflow/queue/take-next';
    const COMMAND_GET_IN_PROGRESS = '/app/exam-workflow/item/in-process';
    const SUBSCRIBE_QUEUE_LIST = '/topic/exam-workflow/queue/'; 
    const SUBSCRIBE_ITEM_DETAILS = '/user/queue/exam-workflow/item/details'; 
    const SUBSCRIBE_QUEUE_SIZE_REPLY = '/user/queue/query-size-reply';
    const SUBSCRIBE_ERROR_CHANNEL = '/user/queue/errors';
    const COMMAND_QUERY_QUEUE_SIZE = '/app/exam-workflow/query/queue-size';

    let stompClient = null;
    let currentDepartmentId = null; 
    let currentQueueItemType = null;

    // H√†m ghi log ra giao di·ªán
    function logMessage(message, type = 'info') {
        const log = document.getElementById('log-output');
        const now = new Date().toLocaleTimeString();
        log.innerHTML = `<div class="log-entry" style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'black'};">
            [${now}] [${type.toUpperCase()}] ${message}
        </div>` + log.innerHTML;
    }

    // --- H√†m K·∫øt n·ªëi ---
    function attemptConnect() {
        const token = document.getElementById('doctor-token').value;
        const departmentId = document.getElementById('department-id').value;
        
        if (!token || !departmentId) {
            logMessage("Vui l√≤ng nh·∫≠p Staff ID v√† Dept ID.", 'error');
            return;
        }

        currentDepartmentId = departmentId;
        logMessage(`ƒêang c·ªë k·∫øt n·ªëi t·ªõi: ${SERVER_URL + HANDSHAKE_ENDPOINT}`, 'info');

        const socket = new SockJS(SERVER_URL + HANDSHAKE_ENDPOINT);
        stompClient = Stomp.over(socket);

        // Thi·∫øt l·∫≠p Header STOMP CONNECT (Truy·ªÅn JWT)
        const headers = {
            'Authorization': 'Bearer ' + token, 
        };
        
        stompClient.connect(headers, 
            (frame) => {
                document.getElementById('status').textContent = 'ƒê√É K·∫æT N·ªêI (Principal: ' + frame.headers.user + ')';
                document.getElementById('status').style.color = 'green';
                document.getElementById('take-next-btn').disabled = false;
                document.getElementById('take-queue-size-btn').disabled = false;
                document.getElementById('get-in-progress-btn').disabled = false;
                logMessage('K·∫øt n·ªëi th√†nh c√¥ng. B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω k√™nh.', 'success');
                subscribeToChannels(currentDepartmentId);
            }, 
            (error) => {
                document.getElementById('status').textContent = 'L·ªñI K·∫æT N·ªêI: ' + (error.message || error);
                document.getElementById('status').style.color = 'red';
                document.getElementById('take-next-btn').disabled = true;
                document.getElementById('take-queue-size-btn').disabled = true;
                document.getElementById('get-in-progress-btn').disabled = true;
                logMessage('L·ªói k·∫øt n·ªëi WebSocket: ' + error, 'error');
                console.error(error);
            }
        );
    }

    // --- H√†m Subscription ---
    function subscribeToChannels(departmentId) {
        // 1. Subscribe k√™nh chung c·ªßa ph√≤ng ban
        const queueListDestination = SUBSCRIBE_QUEUE_LIST + departmentId + '/list';
        stompClient.subscribe(queueListDestination, (message) => {
            const payload = JSON.parse(message.body);
            logMessage(`[PUB/SUB] C·∫≠p nh·∫≠t Queue (${departmentId}): Size = ${payload}`, 'info');
            document.getElementById('queue-size').textContent = payload;
        });

        // 2. Subscribe k√™nh c√° nh√¢n
        stompClient.subscribe(SUBSCRIBE_ITEM_DETAILS, (message) => {
            const details = JSON.parse(message.body);
            logMessage(`[PRIVATE] Nh·∫≠n Chi ti·∫øt Phi·∫øu kh√°m cho ID: ${details.queueItemId}`, 'success');
            document.getElementById('item-details').textContent = JSON.stringify(details);
            updateDynamicDisplay(details);
        },{id: 'item-details-sub'});

        // 3. Subscribe K√™nh Nh·∫≠n Ph·∫£n h·ªìi Query K√≠ch th∆∞·ªõc H√†ng ƒë·ª£i
        stompClient.subscribe(SUBSCRIBE_QUEUE_SIZE_REPLY, (message) => {
            const currentSize = JSON.parse(message.body);
            logMessage(`[REPLY] Nh·∫≠n k√≠ch th∆∞·ªõc h√†ng ƒë·ª£i ban ƒë·∫ßu: ${currentSize}`, 'success');
            document.getElementById('queue-size').textContent = currentSize;
        },{id: 'queue-size-reply-sub'});

        // 4. Subscribe k√™nh nh·∫≠n l·ªói
        stompClient.subscribe(SUBSCRIBE_ERROR_CHANNEL, (message) => {
            let errorText = message.body;
            try {
                const errorObj = JSON.parse(message.body);
                errorText = errorObj.message || errorObj.error || JSON.stringify(errorObj);
            } catch (e) {
                errorText = message.body;
            }
            logMessage(`[ERROR] L·ªói t·ª´ Server: ${errorText}`, 'error');
            document.getElementById('item-details').textContent = errorText;
            document.getElementById('take-next-btn').disabled = false;
        }, {id: 'error-sub'});

        // Sau khi SUBSCRIBE xong, g·ª≠i y√™u c·∫ßu l·∫•y tr·∫°ng th√°i ban ƒë·∫ßu
        requestInitialQueueState(departmentId);
    }

    function updateDynamicDisplay(details) {
        document.getElementById('patient-status').textContent = details?.medicalForm?.medicalFormStatus;
        document.getElementById('patient-name').textContent = details?.medicalForm?.examination?.patientName || details?.medicalForm?.patientName;
        document.getElementById('patient-id').textContent = details?.medicalForm?.examination?.patientId || details?.medicalForm?.patientId;
        document.getElementById('service-name').textContent = details?.requestedService?.name;
        document.getElementById('service-id-view').textContent = details?.requestedService?.serviceId;
        document.getElementById('queueItemIdView').textContent = details?.queueItemId;
        document.getElementById('examIdView').textContent = details?.medicalForm?.examination?.id;
        document.getElementById('queueItemType').textContent = details?.type;

        // Store current type
        currentQueueItemType = details?.type;

        // Hide both forms first
        document.getElementById('exam-form').style.display = 'none';
        document.getElementById('payment-form').style.display = 'none';

        // Show appropriate form based on type
        if (details?.type === 'EXAM_SERVICE') {
            // Show exam form
            document.getElementById('exam-form').style.display = 'block';
            document.getElementById('queueItemIdInput').value = details.queueItemId;
            document.getElementById('examIdInput').value = details.medicalForm.examination.id;
            document.getElementById('serviceIdInput').value = details.requestedService.serviceId;
        } else if (details?.type === 'RECEPTION_PAYMENT') {
            // Show payment form
            document.getElementById('payment-form').style.display = 'block';
            document.getElementById('invoiceIdInput').value = details.medicalForm?.invoice?.invoiceId || '';
        }
    }

    function requestInitialQueueState(queueId) {
        if (!stompClient || !stompClient.connected) {
            logMessage("L·ªói: K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng ƒë·ªÉ g·ª≠i Query.", 'error');
            return;
        }

        stompClient.send(COMMAND_QUERY_QUEUE_SIZE, {}, JSON.stringify(queueId));
        logMessage(`[SEND] G·ª≠i y√™u c·∫ßu l·∫•y Queue Size hi·ªán t·∫°i cho ph√≤ng: ${queueId}`, 'info');
    }

    // --- H√†m G·ª≠i Command L·∫•y Phi·∫øu Kh√°m ---
    function takeNextPatient() {
        if (!stompClient || !stompClient.connected) {
            logMessage("K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng. Vui l√≤ng k·∫øt n·ªëi tr∆∞·ªõc.", 'error');
            return;
        }

        const payload = {
            queueId: currentDepartmentId
        };

        stompClient.send(COMMAND_TAKE_ITEM, {}, JSON.stringify(payload));
        logMessage(`[SEND] G·ª≠i l·ªánh l·∫•y phi·∫øu cho ph√≤ng: ${currentDepartmentId}`, 'info');
    }

    // --- H√†m Ho√†n Th√†nh Kh√°m (HTTP POST) ---
    function completeExam() {
        const examId = document.getElementById('examIdInput').value;
        const serviceId = document.getElementById('serviceIdInput').value;
        const data = document.getElementById('examData').value;
        const staffId = document.getElementById('doctor-token').value;

        if (!examId || !serviceId || !staffId) {
            logMessage("Thi·∫øu th√¥ng tin ƒë·ªÉ ho√†n th√†nh kh√°m", 'error');
            return;
        }

        // Parse data from textarea (if provided)
        let parsedData = {};
        if (data && data.trim()) {
            try {
                parsedData = JSON.parse(data);
            } catch (e) {
                logMessage("L·ªói: D·ªØ li·ªáu JSON kh√¥ng h·ª£p l·ªá", 'error');
                return;
            }
        }

        const payload = {
            serviceId: serviceId,
            data: parsedData
        };

        const url = `${EXAMINATION_SERVICE_URL}/examination/${examId}/result`;

        logMessage(`[HTTP POST] G·ª≠i y√™u c·∫ßu ho√†n th√†nh kh√°m t·ªõi: ${url}`, 'info');

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Staff-Id': staffId
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (response.ok) {
                logMessage("‚úÖ Ho√†n th√†nh kh√°m th√†nh c√¥ng!", 'success');
                return response.text();
            } else {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
        })
        .then(data => {
            logMessage(`Response: ${data || 'No content'}`, 'success');
        })
        .catch(error => {
            logMessage(`‚ùå L·ªói ho√†n th√†nh kh√°m: ${error.message}`, 'error');
            console.error(error);
        });
    }

    // --- H√†m T·∫°o Giao D·ªãch Thanh To√°n (HTTP POST) ---
    function createPaymentTransaction() {
        const invoiceId = document.getElementById('invoiceIdInput').value;
        const paymentMethod = document.getElementById('paymentMethodInput').value;
        const staffId = document.getElementById('doctor-token').value;

        if (!invoiceId || !paymentMethod || !staffId) {
            logMessage("Thi·∫øu th√¥ng tin ƒë·ªÉ t·∫°o giao d·ªãch thanh to√°n", 'error');
            return;
        }

        const payload = {
            invoiceId: invoiceId,
            paymentMethod: paymentMethod
        };

        const url = `${PAYMENT_SERVICE_URL}/payment/transactions`;

        logMessage(`[HTTP POST] G·ª≠i y√™u c·∫ßu t·∫°o giao d·ªãch t·ªõi: ${url}`, 'info');

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Staff-Id': staffId
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
        })
        .then(data => {
            logMessage(`‚úÖ T·∫°o giao d·ªãch th√†nh c√¥ng! Transaction ID: ${data.transactionId || 'N/A'}`, 'success');
            logMessage(`Payment URL: ${data.paymentUrl || 'N/A'}`, 'info');
            
            // Optionally open payment URL
            if (data.paymentUrl) {
                window.open(data.paymentUrl, '_blank');
            }
        })
        .catch(error => {
            logMessage(`‚ùå L·ªói t·∫°o giao d·ªãch: ${error.message}`, 'error');
            console.error(error);
        });
    }

    // --- H√†m G·ª≠i Command L·∫•y Phi·∫øu ƒêang X·ª≠ L√Ω ---
    function getInProgressPatient() {
        if (!stompClient || !stompClient.connected) {
            logMessage("K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng. Vui l√≤ng k·∫øt n·ªëi tr∆∞·ªõc.", 'error');
            return;
        }

        stompClient.send(COMMAND_GET_IN_PROGRESS, {});
        logMessage("ƒê√£ g·ª≠i y√™u c·∫ßu l·∫•y phi·∫øu ƒëang x·ª≠ l√Ω", "info");
    }
    
    // ƒê·∫£m b·∫£o n√∫t s·∫µn s√†ng
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('take-next-btn').disabled = true;
        document.getElementById('get-in-progress-btn').disabled = true;
    });

</script>

</body>
</html>