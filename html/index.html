<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Examination Flow Client Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        #status { font-weight: bold; }
        .output { margin-top: 15px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; height: 300px; overflow-y: scroll; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px dotted #eee; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<div class="container">
    <h1>üë®‚Äç‚öïÔ∏è Examination Flow Client Test</h1>

    <p>Tr·∫°ng th√°i k·∫øt n·ªëi: <span id="status">ƒêang ng·∫Øt k·∫øt n·ªëi...</span></p>
    <hr>
    
    <h2>1. H√†nh ƒë·ªông</h2>
    <label for="doctor-token">JWT Token:</label>
    <input type="text" id="doctor-token" size="60" value="c70892d3-5ee0-4cff-a606-7251885fdd7f" placeholder="Nh·∫≠p JWT Token h·ª£p l·ªá">
    
    <label for="department-id">Dept ID:</label>
    <input type="text" id="department-id" size="10" value="a1ab0cce-bb0c-4604-adc1-05c6c5a15ea4" placeholder="V√≠ d·ª•: ULTRASOUND">
    <br><br>
    
    <button onclick="attemptConnect()">K·∫øt n·ªëi WebSocket</button>
    <button onclick="takeNextPatient()" id="take-next-btn" disabled>L·∫•y Phi·∫øu Kh√°m Ti·∫øp Theo</button>
    <button onclick="requestInitialQueueState(currentDepartmentId)" id="take-queue-size-btn" disabled>L·∫•y queue size</button>
    
    <hr>

<hr>
<h2>2. Th√¥ng tin Nh·∫≠n ƒë∆∞·ª£c</h2>
<p>Queue Size: <span id="queue-size" style="color: blue; font-weight: bold">N/A</span></p>


<h3>Chi ti·∫øt Phi·∫øu Kh√°m C·∫ßn X·ª≠ l√Ω</h3>
<div id="item-details" class="output">Ch∆∞a c√≥ d·ªØ li·ªáu...</div>


<div class="block">
<p class="detail-line"><strong>Tr·∫°ng th√°i:</strong> <span id="patient-status">N/A</span></p>
<p class="detail-line"><strong>B·ªánh nh√¢n:</strong> <span id="patient-name">N/A</span> (<span id="patient-id">N/A</span>)</p>
<p class="detail-line"><strong>D·ªãch v·ª•:</strong> <span id="service-name">N/A</span> (<span id="service-id-view">N/A</span>)</p>
<p class="detail-line"><strong>Queue Item ID:</strong> <span id="queueItemIdView">N/A</span></p>
<p class="detail-line"><strong>Exam ID:</strong> <span id="examIdView">N/A</span></p>
</div>


<h3>Log</h3>
<div id="log-output" class="output"></div>
<hr>


<h2>3. Ho√†n th√†nh Phi·∫øu Kh√°m</h2>
<label>Queue Item ID:</label>
<input id="queueItemIdInput" size="40" disabled>
<br><label>Exam ID:</label>
<input id="examIdInput" size="40" disabled>
<br><label>Service ID:</label>
<input id="serviceIdInput" size="40" disabled>
<br><br>
<label>Exam Data (JSON):</label>
<textarea id="examData" rows="4" cols="60">{"diagnosis": "Ch∆∞a c√≥ k·∫øt qu·∫£"}</textarea>
<br><br>
<button id="complete-btn" onclick="completePatient()" disabled>Ho√†n Th√†nh</button>
</div>

<script>
    // --- C·∫•u h√¨nh Server ---
    const SERVER_URL = 'http://localhost:9093'; 
    const HANDSHAKE_ENDPOINT = '/ws/exam-workflow'; 
    
    // C√°c k√™nh giao ti·∫øp STOMP n·ªôi b·ªô ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh
    const COMMAND_TAKE_ITEM = '/app/exam-workflow/queue/take-next';
    const COMMAND_COMPLETE_ITEM = '/app/exam-workflow/item/complete'; // B·ªî SUNG COMMAND M·ªöI
    const SUBSCRIBE_QUEUE_LIST = '/topic/exam-workflow/queue/'; 
    const SUBSCRIBE_ITEM_DETAILS = '/user/queue/exam-workflow/item/details'; 
    const SUBSCRIBE_QUEUE_SIZE_REPLY = '/user/queue/query-size-reply';
    const SUBSCRIBE_ERROR_CHANNEL = '/user/queue/errors';
    const COMMAND_QUERY_QUEUE_SIZE = '/app/exam-workflow/query/queue-size';

    let stompClient = null;
    let currentDepartmentId = null; 

    // H√†m ghi log ra giao di·ªán
    function logMessage(message, type = 'info') {
        const log = document.getElementById('log-output');
        const now = new Date().toLocaleTimeString();
        log.innerHTML = `<div class="log-entry" style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'black'};">
            [${now}] [${type.toUpperCase()}] ${message}
        </div>` + log.innerHTML;
    }

    // --- H√†m K·∫øt n·ªëi ---
    function attemptConnect() {
        const token = document.getElementById('doctor-token').value;
        const departmentId = document.getElementById('department-id').value;
        
        if (!token || !departmentId) {
            logMessage("Vui l√≤ng nh·∫≠p Token v√† Dept ID.", 'error');
            return;
        }

        currentDepartmentId = departmentId;
        logMessage(`ƒêang c·ªë k·∫øt n·ªëi t·ªõi: ${SERVER_URL + HANDSHAKE_ENDPOINT}`, 'info');

        const socket = new SockJS(SERVER_URL + HANDSHAKE_ENDPOINT);
        stompClient = Stomp.over(socket);

        // Thi·∫øt l·∫≠p Header STOMP CONNECT (Truy·ªÅn JWT)
        const headers = {
            'Authorization': 'Bearer ' + token, 
        };
        
        stompClient.connect(headers, 
            (frame) => {
                document.getElementById('status').textContent = 'ƒê√É K·∫æT N·ªêI (Principal: ' + frame.headers.user + ')';
                document.getElementById('status').style.color = 'green';
                document.getElementById('take-next-btn').disabled = false;
                document.getElementById('take-queue-size-btn').disabled = false;
                document.getElementById('complete-btn').disabled = false; // B·∫¨T N√öT M·ªöI
                logMessage('K·∫øt n·ªëi th√†nh c√¥ng. B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω k√™nh.', 'success');
                subscribeToChannels(currentDepartmentId);
            }, 
            (error) => {
                document.getElementById('status').textContent = 'L·ªñI K·∫æT N·ªêI: ' + (error.message || error);
                document.getElementById('status').style.color = 'red';
                document.getElementById('take-next-btn').disabled = true;
                document.getElementById('take-queue-size-btn').disabled = true;
                document.getElementById('complete-btn').disabled = true; // T·∫ÆT N√öT M·ªöI
                logMessage('L·ªói k·∫øt n·ªëi WebSocket: ' + error, 'error');
                console.error(error);
            }
        );
    }

    // --- H√†m Subscription ---
    function subscribeToChannels(departmentId) {
        // 1. Subscribe k√™nh chung c·ªßa ph√≤ng ban
        const queueListDestination = SUBSCRIBE_QUEUE_LIST + departmentId + '/list';
        stompClient.subscribe(queueListDestination, (message) => {
            const payload = JSON.parse(message.body);
            logMessage(`[PUB/SUB] C·∫≠p nh·∫≠t Queue (${departmentId}): Size = ${payload}`, 'info');
            document.getElementById('queue-size').textContent = payload; // Nh·∫≠n size l√† Integer
        });

        // 2. Subscribe k√™nh c√° nh√¢n (ƒê√É S·ª¨A URL)
        stompClient.subscribe(SUBSCRIBE_ITEM_DETAILS, (message) => {
            const details = JSON.parse(message.body);
            logMessage(`[PRIVATE] Nh·∫≠n Chi ti·∫øt Phi·∫øu kh√°m cho ID: ${details.queueItemId}`, 'success');
            document.getElementById('item-details').textContent = JSON.stringify(details, null, 2);
            updateDynamicDisplay(details);
        },{id: 'item-details-sub'});

        // 3. Subscribe K√™nh Nh·∫≠n Ph·∫£n h·ªìi Query K√≠ch th∆∞·ªõc H√†ng ƒë·ª£i (ƒê√É S·ª¨A URL)
        stompClient.subscribe(SUBSCRIBE_QUEUE_SIZE_REPLY, (message) => {
            const currentSize = JSON.parse(message.body);
            logMessage(`[REPLY] Nh·∫≠n k√≠ch th∆∞·ªõc h√†ng ƒë·ª£i ban ƒë·∫ßu: ${currentSize}`, 'success');
            document.getElementById('queue-size').textContent = currentSize;
        },{id: 'queue-size-reply-sub'});

        // 4. B·ªî SUNG: Subscribe k√™nh nh·∫≠n l·ªói
        stompClient.subscribe(SUBSCRIBE_ERROR_CHANNEL, (message) => {
            let errorText = message.body;
            try {
                // Th·ª≠ ph√¢n t√≠ch JSON (Spring th∆∞·ªùng g·ª≠i l·ªói d∆∞·ªõi d·∫°ng JSON)
                const errorObj = JSON.parse(message.body);
                errorText = errorObj.message || errorObj.error || JSON.stringify(errorObj);
            } catch (e) {
                // N·∫øu kh√¥ng ph·∫£i JSON, d√πng body th√¥
                errorText = message.body;
            }
            logMessage(`[ERROR] L·ªói t·ª´ Server: ${errorText}`, 'error');
            
            // X√≥a chi ti·∫øt phi·∫øu kh√°m n·∫øu l·ªói li√™n quan ƒë·∫øn vi·ªác l·∫•y phi·∫øu
            document.getElementById('item-details').textContent = "Kh√¥ng th·ªÉ l·∫•y phi·∫øu: " + errorText;
            document.getElementById('take-next-btn').disabled = false; // B·∫≠t l·∫°i n√∫t
        }, {id: 'error-sub'}); // ƒê·∫∑t ID cho Subscription

        // Sau khi SUBSCRIBE xong, g·ª≠i y√™u c·∫ßu l·∫•y tr·∫°ng th√°i ban ƒë·∫ßu
        requestInitialQueueState(departmentId);
    }

    function updateDynamicDisplay(details){
        document.getElementById('patient-status').textContent=details?.medicalForm?.medicalFormStatus;
        document.getElementById('patient-name').textContent=details?.medicalForm?.examination?.patientName;
        document.getElementById('patient-id').textContent=details?.medicalForm?.examination?.patientId;
        document.getElementById('service-name').textContent=details?.requestedService?.name;
        document.getElementById('service-id-view').textContent=details?.requestedService?.serviceId;
        document.getElementById('queueItemIdView').textContent=details?.queueItemId;
        document.getElementById('examIdView').textContent=details?.medicalForm?.examination?.id;


        document.getElementById('queueItemIdInput').value=details.queueItemId;
        document.getElementById('examIdInput').value=details.medicalForm.examination.id;
        document.getElementById('serviceIdInput').value=details.requestedService.serviceId;
    }

    function requestInitialQueueState(queueId) {
        if (!stompClient || !stompClient.connected) {
            logMessage("L·ªói: K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng ƒë·ªÉ g·ª≠i Query.", 'error');
            return;
        }

        // G·ª≠i t√™n ph√≤ng ban l√†m payload (v√≠ d·ª•: "ULTRASOUND")
        stompClient.send(COMMAND_QUERY_QUEUE_SIZE, {}, JSON.stringify(queueId));
        logMessage(`[SEND] G·ª≠i y√™u c·∫ßu l·∫•y Queue Size hi·ªán t·∫°i cho ph√≤ng: ${queueId}`, 'info');
    }

    // --- H√†m G·ª≠i Command L·∫•y Phi·∫øu Kh√°m ---
    function takeNextPatient() {
        if (!stompClient || !stompClient.connected) {
            logMessage("K·∫øt n·ªëi ch∆∞a s·∫µn s√†ng. Vui l√≤ng k·∫øt n·ªëi tr∆∞·ªõc.", 'error');
            return;
        }

        const payload = {
            queueId: currentDepartmentId
            // C√°c tr∆∞·ªùng kh√°c n·∫øu c·∫ßn (v√≠ d·ª•: deviceId, kioskId)
        };

        stompClient.send(COMMAND_TAKE_ITEM, {}, JSON.stringify(payload));
        logMessage(`[SEND] G·ª≠i l·ªánh l·∫•y phi·∫øu cho ph√≤ng: ${currentDepartmentId}`, 'info');
    }

    // --- B·ªî SUNG: H√†m G·ª≠i Command Ho√†n Th√†nh Phi·∫øu Kh√°m ---
    function completePatient(){
        const payload={
        queueItemId:document.getElementById('queueItemIdInput').value,
        examId:document.getElementById('examIdInput').value,
        serviceId:document.getElementById('serviceIdInput').value,
        data:document.getElementById('examData').value
        };
        stompClient.send(COMMAND_COMPLETE_ITEM,{},JSON.stringify(payload));
        logMessage("ƒê√£ g·ª≠i CompleteItemRequest","success");
    }
    
    // ƒê·∫£m b·∫£o n√∫t "L·∫•y phi·∫øu" v√† "Ho√†n Th√†nh" s·∫µn s√†ng
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('take-next-btn').disabled = true;
        document.getElementById('complete-btn').disabled = true; // B·ªî SUNG
    });

</script>

</body>
</html>